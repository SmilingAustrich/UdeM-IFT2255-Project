<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Requêtes de Travail</title>
    <link rel="stylesheet" href="stylesMainMenu.css">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons"></script>
</head>
<body>
<!-- Header Section -->
<div class="header">
    <div class="header__logo">
        <strong>Ma Ville</strong>
    </div>
    <nav class="navbar">
        <ul class="navbar__menu">
            <li class="navbar__item">
                <a href="index.html" class="navbar__link">
                    <span>Home</span>
                </a>
            </li>
            <li class="navbar__item">
                <a href="#" class="navbar__link">
                    <span>Messages</span>
                </a>
            </li>
            <li class="navbar__item">
                <a href="consulterTravaux.html" class="navbar__link">
                    <span>Rechercher Travaux</span>
                </a>
            </li>
            <li class="navbar__item">
                <a href="consulterEntraves.html" class="navbar__link">
                    <span>Consulter Entraves</span>
                </a>
            </li>
            <li class="navbar__item">
                <a href="requeteTravail.html" class="navbar__link">
                    <span>Soumettre une Requête</span>
                </a>
            </li>
            <li class="navbar__item">
                <a href="#" class="navbar__link">
                    <span>Settings</span>
                </a>
            </li>
            <li class="navbar__item">
                <a href="mesrequetes.html" class="navbar__link">
                    <span>Mes Requêtes</span>
                </a>
            </li>
        </ul>


    </nav>

</div>

<!-- Main Content -->
<div class="content">
    <h1>Mes Requêtes de Travail</h1>

    <!-- Requests Section -->
    <div id="work-requests" class="work-requests">
        <h2>Vos Requêtes</h2>
        <ul id="request-list" class="request-list">
            <!-- Dynamic list of requests will be inserted here -->
        </ul>
    </div>

    <!-- Candidatures Section -->
    <div id="candidatures" class="candidatures" style="display: none;">
        <h2>Candidatures pour la Requête</h2>
        <ul id="candidature-list" class="candidature-list">
            <!-- Dynamic list of candidatures will be inserted here -->
        </ul>
        <button id="back-to-requests" class="btn">Retour</button>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", fetchWorkRequests);

    const residentId = 1; // Example ID, replace with dynamic user ID when integrating authentication

    // Fetch resident's work requests
    function fetchWorkRequests() {
        fetch(`/work-requests/resident/${residentId}/requests`)
            .then((response) => response.json())
            .then((data) => displayWorkRequests(data))
            .catch((error) => console.error('Erreur lors du chargement des requêtes:', error));
    }

    // Display work requests in a list
    function displayWorkRequests(requests) {
        const requestList = document.getElementById('request-list');
        requestList.innerHTML = ''; // Clear existing content

        if (requests.length === 0) {
            requestList.innerHTML = '<p>Aucune requête trouvée.</p>';
            return;
        }

        requests.forEach(request => {
            const listItem = document.createElement('li');
            listItem.innerHTML = `
                <strong>Titre:</strong> ${request.workTitle} <br>
                <strong>Type:</strong> ${request.workType} <br>
                <strong>Date souhaitée:</strong> ${request.workWishedStartDate} <br>
                <button onclick="viewCandidatures(${request.id})" class="btn">Voir les Candidatures</button>
            `;
            requestList.appendChild(listItem);
        });
    }

    // Fetch and display candidatures for a specific request
    function viewCandidatures(requestId) {
        fetch(`/work-requests/${requestId}`)
            .then((response) => response.json())
            .then((data) => {
                displayCandidatures(data.candidatures, requestId);
            })
            .catch((error) => console.error('Erreur lors du chargement des candidatures:', error));
    }

    // Display candidatures for a request
    function displayCandidatures(candidatures, requestId) {
        const candidaturesSection = document.getElementById('candidatures');
        const candidatureList = document.getElementById('candidature-list');
        const requestsSection = document.getElementById('work-requests');

        // Toggle sections
        requestsSection.style.display = 'none';
        candidaturesSection.style.display = 'block';

        candidatureList.innerHTML = ''; // Clear existing content

        if (candidatures.length === 0) {
            candidatureList.innerHTML = '<p>Aucune candidature pour cette requête.</p>';
            return;
        }

        candidatures.forEach(candidature => {
            const listItem = document.createElement('li');
            listItem.innerHTML = `
                <strong>Intervenant ID:</strong> ${candidature.intervenantId} <br>
                <strong>Message:</strong> ${candidature.message} <br>
                <button onclick="acceptCandidature(${requestId}, ${candidature.intervenantId})" class="btn">Accepter</button>
            `;
            candidatureList.appendChild(listItem);
        });

        // Back to requests
        document.getElementById('back-to-requests').onclick = () => {
            candidaturesSection.style.display = 'none';
            requestsSection.style.display = 'block';
        };
    }

    // Accept a candidature
    function acceptCandidature(requestId, intervenantId) {
        fetch(`/work-requests/${requestId}/accept-candidature/${intervenantId}`, {
            method: "POST"
        })
            .then((response) => {
                if (!response.ok) throw new Error('Erreur lors de l\'acceptation de la candidature.');
                alert("Candidature acceptée avec succès!");
                fetchWorkRequests(); // Refresh requests
                document.getElementById('candidatures').style.display = 'none';
                document.getElementById('work-requests').style.display = 'block';
            })
            .catch((error) => console.error('Erreur:', error));
    }
</script>
</body>
</html>
