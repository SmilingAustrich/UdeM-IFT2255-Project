<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Préférences</title>
    <link rel="stylesheet" href="../styles/stylesMainMenu.css">
</head>
<body>
<!-- Header Section -->
<div id="header"></div>
<script src="../javascript/headerResident.js"></script>

<!-- Main Content -->
<div class="content">
    <h1>Mes Préférences</h1>
    <div id="preferencesContainer">
        <p>Chargement des préférences...</p>
    </div>
</div>
</body>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        const preferencesContainer = document.getElementById('preferencesContainer');
        const residentId = localStorage.getItem('residentId'); // Retrieve residentId from localStorage

        if (!residentId) {
            alert("Utilisateur non authentifié");
            return;
        }

        // Fetch preferences on page load
        fetch(`/residents/${residentId}/preferences`)
            .then(response => {
                if (response.status === 204) {
                    preferencesContainer.innerHTML = '<p>Aucune préférence trouvée.</p>';
                } else if (response.ok) {
                    return response.json();
                } else {
                    throw new Error("Erreur lors du chargement des préférences");
                }
            })
            .then(preferences => {
                if (preferences && Array.isArray(preferences)) {
                    updatePreferencesView(preferences);
                }
            })
            .catch(error => {
                console.error('Erreur lors du chargement des préférences:', error);
                preferencesContainer.innerHTML = '<p>Erreur lors du chargement des préférences.</p>';
            });

        // Update "Mes Préférences" section
        function updatePreferencesView(preferences) {
            preferencesContainer.innerHTML = ''; // Clear previous content

            if (!preferences || preferences.length === 0) {
                preferencesContainer.innerHTML = '<p>Aucune préférence trouvée.</p>';
                return;
            }

            const list = document.createElement('ul');
            preferences.forEach(pref => {
                const item = document.createElement('li');
                item.textContent = `${pref.day}: ${pref.startTime} - ${pref.endTime}`;

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Supprimer';
                deleteButton.className = 'delete-btn';
                deleteButton.addEventListener('click', () => {
                    deletePreference(pref);
                });

                item.appendChild(deleteButton);
                list.appendChild(item);
            });
            preferencesContainer.appendChild(list);
        }

        // Delete a preference
        function deletePreference(pref) {
            const confirmed = confirm(`Voulez-vous supprimer cette préférence: ${pref.day}: ${pref.startTime} - ${pref.endTime} ?`);
            if (!confirmed) return;

            fetch(`/residents/${residentId}/preferences`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(pref)
            })
                .then(response => {
                    if (response.ok) {
                        alert('Préférence supprimée avec succès');
                        fetchPreferences(); // Refresh the preferences view
                    } else {
                        response.text().then(text => alert(`Erreur: ${text}`));
                    }
                })
                .catch(error => {
                    console.error('Erreur lors de la suppression de la préférence:', error);
                    alert('Une erreur est survenue');
                });
        }

        // Fetch updated preferences
        function fetchPreferences() {
            fetch(`/residents/${residentId}/preferences`)
                .then(response => {
                    if (response.status === 204) {
                        preferencesContainer.innerHTML = '<p>Aucune préférence trouvée.</p>';
                    } else if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error("Erreur lors du chargement des préférences");
                    }
                })
                .then(preferences => {
                    if (preferences && Array.isArray(preferences)) {
                        updatePreferencesView(preferences);
                    }
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des préférences:', error);
                    preferencesContainer.innerHTML = '<p>Erreur lors du chargement des préférences.</p>';
                });
        }
    });
</script>
</html>
