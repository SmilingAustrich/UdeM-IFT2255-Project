<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulter Entraves</title>
    <link rel="stylesheet" href="../styles/stylesMainMenu.css">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons"></script>
</head>
<body>

<!-- Header Section -->

<div id="header"></div>
<script src="../javascript/headerResident.js"></script>




<!-- Main Content -->
<div class="content">
    <h1>Consulter les Entraves</h1>

    <!-- Button and Search Form Container -->
    <div class="button-form-container">
        <button id="view-all-entraves" class="view-all-btn">Afficher Toutes les Entraves</button>
        <form id="search-form" class="search-form">
            <label for="search-type">Rechercher par:</label>
            <select id="search-type">
                <option value="street">Nom de Rue</option>
                <option value="work-id">ID de Travail</option>
            </select>
            <input type="text" id="search-input" placeholder="Entrez votre recherche..." />
            <button type="submit" class="search-btn">Rechercher</button>
        </form>
    </div>

    <!-- Results Section -->
    <div id="results" class="results">
        <!-- Dynamic results will be displayed here -->
    </div>

    <!-- Pagination Section -->
    <div class="pagination">
        <button id="prev-page" disabled>Précédent</button>
        <span id="page-info">Page: 1</span>
        <button id="next-page">Suivant</button>
    </div>
</div>

<script>
    // Initialize Feather Icons
    feather.replace();

    let currentPage = 1;
    const resultsPerPage = 10;

    // Handle "Afficher Toutes les Entraves" button click
    document.getElementById('view-all-entraves').addEventListener('click', () => {
        fetchEntraves(currentPage, resultsPerPage);
    });

    // Handle form submission for search
    document.getElementById('search-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const searchType = document.getElementById('search-type').value;
        const searchValue = document.getElementById('search-input').value.trim();

        if (!searchValue) {
            alert('Veuillez entrer une valeur de recherche.');
            return;
        }

        const endpoint =
            searchType === 'street'
                ? `/entraves/by-street/${encodeURIComponent(searchValue)}`
                : `/entraves/by-work-id/${encodeURIComponent(searchValue)}`;

        fetch(endpoint)
            .then((response) => {
                if (!response.ok) {
                    throw new Error('Erreur lors de la récupération des données.');
                }
                return response.json();
            })
            .then((data) => {
                displayResults(data, searchType, searchValue);
            })
            .catch((error) => {
                console.error(error);
                document.getElementById('results').innerHTML =
                    '<p class="error">Erreur lors du chargement des entraves.</p>';
            });
    });

    // Fetch and display entraves with pagination
    function fetchEntraves(page, limit) {
        fetch(`/entraves/getAllEntraves?page=${page}&limit=${limit}`)
            .then((response) => {
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then((data) => {
                displayResults(data.results, 'all', '');
                updatePagination(data.total, page, limit);
            })
            .catch((error) => {
                console.error('Erreur lors du chargement:', error);
                document.getElementById('results').innerHTML =
                    '<p class="error">Erreur lors du chargement des entraves. Veuillez réessayer.</p>';
            });
    }

    // Display Results
    function displayResults(data, type, value) {
        const resultsContainer = document.getElementById('results');
        resultsContainer.innerHTML = `<h2>Résultats ${type !== 'all' ? `pour "${value}"` : 'de Toutes les Entraves'}</h2>`;

        if (data.length === 0) {
            resultsContainer.innerHTML += '<p>Aucun résultat trouvé.</p>';
        } else {
            const list = document.createElement('ul');
            list.className = 'result-list';
            data.forEach((entrave) => {
                const item = document.createElement('li');
                item.innerHTML = `
                <strong>ID:</strong> ${entrave.id_request || 'N/A'}<br>
                <strong>Rue:</strong> ${entrave.shortname || 'N/A'}<br>
                <strong>Impact:</strong> ${entrave.streetimpacttype || 'N/A'}
            `;
                list.appendChild(item);
            });
            resultsContainer.appendChild(list);
        }
    }

    // Update Pagination Controls
    function updatePagination(totalResults, currentPage, limit) {
        const totalPages = Math.ceil(totalResults / limit);
        document.getElementById('page-info').innerText = `Page: ${currentPage}`;
        document.getElementById('prev-page').disabled = currentPage === 1;
        document.getElementById('next-page').disabled = currentPage === totalPages;

        document.getElementById('prev-page').onclick = () => {
            if (currentPage > 1) {
                currentPage -= 1;
                fetchEntraves(currentPage, resultsPerPage);
            }
        };

        document.getElementById('next-page').onclick = () => {
            if (currentPage < totalPages) {
                currentPage += 1;
                fetchEntraves(currentPage, resultsPerPage);
            }
        };
    }

</script>
</body>
</html>
